pipeline {
  agent any
  options {
    timeout(time: 30, unit: 'MINUTES')
    preserveStashes(buildCount: 5)
    skipDefaultCheckout()
  }

  stages {
    stage('Clean Workspace') {
      steps {
        script {
          echo "üßπ Cleaning workspace‚Ä¶"
          cleanWs()
        }
      }
    }

    stage('Checkout') {
      steps {
        git url: 'https://github.com/Sarman-Keshwani/Listygo-Prod.git', branch: 'main'
      }
    }

    stage('Build & Deploy') {
      steps {
        sh '''
          # free up 5173
          for c in $(docker ps --filter "publish=5173" --format "{{.ID}}"); do
            docker stop $c && docker rm $c
          done

          BUILD_VERSION=$(date +%s)
          docker build --no-cache --build-arg BUILD_VERSION=$BUILD_VERSION -t home-frontend .
          docker rm -f home-frontend-1 || true
          docker run -d --name home-frontend-1 -p 5173:80 home-frontend
        '''
      }
    }
  }

  post {
    success { echo '‚úÖ Frontend deployed!' }
    failure { echo '‚ùå Frontend failed‚Äîsee above.' }
  }
}
