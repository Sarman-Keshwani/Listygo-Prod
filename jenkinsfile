pipeline {
  agent any

  options {
    // we’ll do our own checkout, so skip the default
    skipDefaultCheckout()
  }

  stages {
    stage('Clean & Checkout') {
      steps {
        deleteDir()
        git branch: 'adi-be',
            url:   'https://github.com/Aditya-Garg10/Listygo.git'
      }
    }

    stage('Inject Firebase Creds') {
      steps {
        configFileProvider([configFile(
          fileId: 'firebaseCredentials',      // your managed-file ID
          targetLocation: 'firebase-credentials.json'
        )]) {
          echo "✔️ Injected firebase-credentials.json"
        }
      }
    }

    stage('Inject ENV file') {
      steps {
        configFileProvider([configFile(
          fileId: 'listygo-env',              // your managed-file ID
          targetLocation: 'Listygo ENV'
        )]) {
          echo "✔️ Injected .env file at workspace"
        }
      }
    }

    stage('Verify Workspace') {
      steps {
        sh '''
          echo "── Workspace contents ──"
          ls -al .
          echo "──────────────────────"
        '''
      }
    }

    stage('Build & Deploy') {
      steps {
        sh '''
          # 1) Stop & remove any containers binding port 8000
          for c in $(docker ps --filter "publish=8000" --format "{{.ID}}"); do
            docker stop $c || true
            docker rm   $c || true
          done

          # 2) Remove any old home-backend-1 by name
          docker rm -f home-backend-1 || true

          # 3) Build fresh image
          docker build --no-cache -t home-backend .

          # 4) Run it
          docker run -d \
            --name home-backend-1 \
            -p 8000:3000 \
            home-backend
        '''
      }
    }
  }

  post {
    success {
      echo '✅ Deployment complete—your updated code is now live!'
    }
    failure {
      echo '❌ Deployment failed. Check the logs above.'
    }
  }
}